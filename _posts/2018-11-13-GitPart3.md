---
layout: post
title: 读书笔记—Git团队协作（三）
tags: [开发技术]
---
#### 回滚、还原、重置和变基

* 关键词：Git For Teams -- 读书笔记

### Part2 在工作流中使用命令

#### 回滚、还原、重置和变基

轻则微调一条提交，重则抹除历史记录。错误的提交和移除通常都发生在个人仓库，但你处理错误的方式将会影响到其他人与代码库的交互。

+ 学习目的：
    + 修补一份提交，并加入新的工作
    + 将一份文件恢复到之前的状态
    + 将你的工作目录恢复到上次提交时的状态
    + 还原之前作出的变更
    + 使用变基重塑提交历史记录
    + 从仓库中移除一份文件
    + 移除某个分支上因为错误的合并引入的提交

“你将会学习容易被忽略，但影响巨大的使用技巧”。

#### 1 最佳实践

#### 1.1 描述问题

先了解三个概念：工作目录(你的文件系统中可见的文件)、暂存区(在下一次commit后即将写入仓库的变更的索引)和仓库(存储文件并记录了文件的每次变更)。

![image]({{ site.baseurl }}/assets/img/blog/2018-11-14-NationalPublicServant/0.png)

git将信息存放在不同地方，当你将问题隔离在这些不同的地方时，将能够更好地选择正确的命令序列，将工作恢复到你想到的状态。

选择正确的撤销方法  | 备注  | 解决方案
--------- | --------- | ---------
舍弃工作目录中对一个文件的修改  | 修改的文件未被暂存或提交  | checkout --filename
舍弃工作目录中所有未保存的变更  | 文件已暂存，但未被提交  | reset --hard
合并与某个特定提交(但不含)之间的多个提交  |   | reset --commit
移除所有未保存的变更，包含未跟踪的文件  | 修改的文件未被提交  | clean -fd
移除所有已暂存的变更和在某个提交之前提交的工作，但不移除工作目录中的新文件  |   | reset --hard commit
移除之前的工作，但完整保留提交历史记录("前进式回滚")  | 分支已经被发布，工作目录是干净的  | revert commit
从分支历史记录中移除一个单独的提交  | 修改的文件已经被提交，工作目录是干净的，分支尚未进行发布  | rebase --interactive commit
保留之前的工作，但与另一提交合并  | 选择squash(压缩)选项  | rebase --interactive commit

> 比如：你希望舍弃工作目录中对一个文件的修改，错误的文件副本没有被暂存或提交

![image]({{ site.baseurl }}/assets/img/blog/2018-11-14-NationalPublicServant/1.png)

比如：创建一个列表，列出所有你想要从中恢复的问题场景。问题描述的越好，就越有可能找到正确的解决方案。

> 创建一个流程图来帮助你选择合适的命令

![image]({{ site.baseurl }}/assets/img/blog/2018-11-14-NationalPublicServant/2.png)

#### 1.2 使用分支进行试验性的工作

在分支树上，一个分支与它的兄弟分支是相互独立的。尽管它们有共同的祖先分支，你通常可以看到在树上移除一个分支却不会影响到其他分支。

在Git中，你添加到仓库中的提交与一个或多个分支相关联。如果你签出一个不同的分支，并在这个新的分支上操作提交对象，那么系统会给这些提交对象分配一个新的标识符，而绑定到旧分支上的提交对象不会改变。也就是说，在新的私有分支中工作一定是安全的，当你对结果满意时，再将你的分支并入主分支。

> 在分支中工作帮助你免遭意外的修改，在工作正确且完整后再将它并入主分支

![image]({{ site.baseurl }}/assets/img/blog/2018-11-14-NationalPublicServant/3.png)

如果你在一个工单上进行工作，但不确定应该使用两种方法中的哪一种。这种情况下，你可以从你的工单分支上创建一个新的分支，在新的分支上进行试验性的修改，如果你想要保存这些修改，再将试验性的分支并入你的工单分支。

> git checkout -b exprerimental_idea(使用试验性的分支来测试修改)

> git add --all

> git commit

注意：当你合并两个分支时，可以选择使用带有--squash参数的合并，以将所有提交并入一个提交。通过这种方式合并分支，以后你不能撤销分支合并。





















